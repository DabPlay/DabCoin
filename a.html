<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>DAB Exchange PRO</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body{
    margin:0;
    background:#0f172a;
    font-family:Arial;
    color:white;
}

.wrapper{
    max-width:480px;
    margin:40px auto;
    background:#1e293b;
    padding:25px;
    border-radius:14px;
    box-shadow:0 0 25px rgba(0,0,0,.5);
}

h2{text-align:center;margin-bottom:20px;}

.card{
    background:#0f172a;
    padding:15px;
    border-radius:10px;
    margin-bottom:15px;
}

input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    margin-top:8px;
    font-size:16px;
}

button{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}

.primary{background:#3b82f6;color:white;}
.success{background:#16a34a;color:white;}
.danger{background:#ef4444;color:white;}
.disabled{background:#555;cursor:not-allowed;}

.info{font-size:14px;opacity:.85;margin-top:6px;}

.status{text-align:center;margin-top:15px;font-size:14px;}
.small{font-size:13px;opacity:.7;}
.flex{display:flex;justify-content:space-between;}
.max{cursor:pointer;color:#3b82f6;font-size:13px;}
</style>
</head>
<body>

<div class="wrapper">
<h2>DAB Exchange</h2>

<button class="primary" onclick="connectWallet()">Conectar Wallet</button>

<div class="card">
<div id="wallet">Wallet: -</div>
<div id="balances"></div>
<div id="priceInfo"></div>
</div>

<!-- BUY -->
<div class="card">
<div class="flex">
<span>Comprar DAB</span>
<span class="max" onclick="setMaxBuy()">MAX</span>
</div>
<input type="number" id="buyInput" oninput="previewBuy()" placeholder="Cantidad DBN">

<div class="info" id="buyPreview"></div>
<button id="buyBtn" class="success" onclick="executeBuy()">Comprar DAB</button>
</div>

<!-- REDEEM -->
<div class="card">
<div class="flex">
<span>Redimir DAB</span>
<span class="max" onclick="setMaxRedeem()">MAX</span>
</div>
<input type="number" id="redeemInput" oninput="previewRedeem()" placeholder="Cantidad DAB">

<div class="info" id="redeemPreview"></div>
<button id="redeemBtn" class="danger" onclick="executeRedeem()">Redimir DAB</button>
</div>

<div class="status" id="status"></div>

</div>

<script>

// ========= CONFIG =========
const DAB_ADDRESS = "0x9471052e67163Ac9eD01BAAe0894ec2f59313777";
const DBN_ADDRESS = "0x2fD13338f4e9485fC33Be4DE53F4f6ff536811cD";
const REDEMPTION_ADDRESS = "0x379d02E48fF44cCDcb7Dea222aE823F5d0dEe18c";

const BUY_FEE = 0.02;
const REDEEM_FEE = 0.03;
// ==========================

let provider, signer, user;
let dab, dbn, redemption;

let dabBalance = 0;
let dbnBalance = 0;
let price = 0;
let dailyLimit = 0;

const ERC20_ABI = [
"function approve(address spender,uint256 amount) external returns(bool)",
"function balanceOf(address owner) view returns(uint256)",
"function decimals() view returns(uint8)"
];

const REDEMPTION_ABI = [
"function buyDAB(uint256 dbnAmount) external",
"function redeem(uint256 dabAmount) external",
"function internalPrice() view returns(uint256)",
"function redeemableDBNPerDay() view returns(uint256)"
];

// CONNECT
async function connectWallet(){

if(!window.ethereum){alert("Instala MetaMask");return;}
if(!confirm("¿Conectar wallet?"))return;

provider=new ethers.providers.Web3Provider(window.ethereum);
await provider.send("eth_requestAccounts",[]);
signer=provider.getSigner();
user=await signer.getAddress();

dab=new ethers.Contract(DAB_ADDRESS,ERC20_ABI,provider);
dbn=new ethers.Contract(DBN_ADDRESS,ERC20_ABI,provider);
redemption=new ethers.Contract(REDEMPTION_ADDRESS,REDEMPTION_ABI,provider);

document.getElementById("wallet").innerText="Wallet: "+user;

loadData();
}

// LOAD DATA
async function loadData(){

const dabRaw=await dab.balanceOf(user);
const dbnRaw=await dbn.balanceOf(user);
const dabDec=await dab.decimals();
const dbnDec=await dbn.decimals();

dabBalance=parseFloat(ethers.utils.formatUnits(dabRaw,dabDec));
dbnBalance=parseFloat(ethers.utils.formatUnits(dbnRaw,dbnDec));

const priceRaw=await redemption.internalPrice();
price=parseFloat(ethers.utils.formatUnits(priceRaw,18));

const dailyRaw=await redemption.redeemableDBNPerDay();
dailyLimit=parseFloat(ethers.utils.formatUnits(dailyRaw,dbnDec));

document.getElementById("balances").innerHTML=
"Tienes "+dabBalance.toFixed(4)+" DAB<br>"+
"Tienes "+dbnBalance.toFixed(4)+" DBN";

document.getElementById("priceInfo").innerHTML=
"Precio: 1 DAB = "+price.toFixed(4)+" DBN<br>"+
"Límite diario DBN: "+dailyLimit.toFixed(4);

previewBuy();
previewRedeem();
}

// MAX BUTTONS
function setMaxBuy(){
document.getElementById("buyInput").value=dbnBalance;
previewBuy();
}

function setMaxRedeem(){
document.getElementById("redeemInput").value=dabBalance;
previewRedeem();
}

// PREVIEW BUY
function previewBuy(){

const val=parseFloat(document.getElementById("buyInput").value);
if(!val||val<=0){document.getElementById("buyPreview").innerHTML="";return;}

if(val>dbnBalance){
document.getElementById("buyPreview").innerHTML="❌ No tienes suficiente DBN";
disable("buyBtn");return;
}

const dabBruto=val/price;
const fee=dabBruto*BUY_FEE;
const neto=dabBruto-fee;

document.getElementById("buyPreview").innerHTML=
"Recibirás "+neto.toFixed(4)+" DAB<br>"+
"Fee: "+fee.toFixed(4)+" DAB";

enable("buyBtn");
}

// PREVIEW REDEEM
function previewRedeem(){

const val=parseFloat(document.getElementById("redeemInput").value);
if(!val||val<=0){document.getElementById("redeemPreview").innerHTML="";return;}

if(val>dabBalance){
document.getElementById("redeemPreview").innerHTML="❌ No tienes suficiente DAB";
disable("redeemBtn");return;
}

const dbnBruto=val*price;
const fee=dbnBruto*REDEEM_FEE;
const neto=dbnBruto-fee;

if(neto>dailyLimit){
document.getElementById("redeemPreview").innerHTML=
"⚠ Supera límite diario. Máximo hoy: "+dailyLimit.toFixed(4)+" DBN";
disable("redeemBtn");return;
}

document.getElementById("redeemPreview").innerHTML=
"Recibirás "+neto.toFixed(4)+" DBN<br>"+
"Fee: "+fee.toFixed(4)+" DBN";

enable("redeemBtn");
}

// EXECUTE BUY
async function executeBuy(){

const val=parseFloat(document.getElementById("buyInput").value);
if(!val)return;

document.getElementById("status").innerText="Esperando confirmación...";

const dbnSigner=dbn.connect(signer);
const redemptionSigner=redemption.connect(signer);

const dbnDec=await dbn.decimals();
const parsed=ethers.utils.parseUnits(val.toString(),dbnDec);

const tx1=await dbnSigner.approve(REDEMPTION_ADDRESS,parsed);
await tx1.wait();

const tx2=await redemptionSigner.buyDAB(parsed);
await tx2.wait();

document.getElementById("status").innerText="Compra completada ✔";
loadData();
}

// EXECUTE REDEEM
async function executeRedeem(){

const val=parseFloat(document.getElementById("redeemInput").value);
if(!val)return;

document.getElementById("status").innerText="Esperando confirmación...";

const dabSigner=dab.connect(signer);
const redemptionSigner=redemption.connect(signer);

const dabDec=await dab.decimals();
const parsed=ethers.utils.parseUnits(val.toString(),dabDec);

const tx1=await dabSigner.approve(REDEMPTION_ADDRESS,parsed);
await tx1.wait();

const tx2=await redemptionSigner.redeem(parsed);
await tx2.wait();

document.getElementById("status").innerText="Redimido ✔";
loadData();
}

function disable(id){
document.getElementById(id).classList.add("disabled");
document.getElementById(id).disabled=true;
}

function enable(id){
document.getElementById(id).classList.remove("disabled");
document.getElementById(id).disabled=false;
}

</script>
</body>
</html>
