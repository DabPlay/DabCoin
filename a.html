<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GameSwap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial; background:#0f1117; color:#fff; }
    button { padding:10px; margin:5px; }
    input { padding:8px; width:200px; }
    .ok { color:#4caf50 }
    .err { color:#f44336 }
  </style>
</head>
<body>

<h2>ðŸŽ® GameSwap</h2>

<button id="connect">Conectar Wallet</button>
<p id="account"></p>

<hr>

<p>DBN: <span id="dbnBal">-</span></p>
<p>DAB: <span id="dabBal">-</span></p>

<input id="amount" placeholder="Cantidad" disabled />

<br><br>

<button id="buy" disabled>Comprar DAB</button>
<button id="sell" disabled>Vender DAB</button>
<p id="preview"></p>
<p id="status"></p>
  <script>
let provider, signer, user;

// ðŸ”§ DIRECCIONES
const SWAP = "0xE1d8F4306eF5F0f43804E485Cf9434988ECC828b";
const DBN  = "0x2fD13338f4e9485fC33Be4DE53F4f6ff536811cD";
const DAB  = "0x996fDE168B25dcA1A4aA9A2833e4fd6d7920B4c5";

// ðŸ”§ ABIs (exactos para tu contrato)
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

const SWAP_ABI = [
  "function buy(uint256)",
  "function sell(uint256)",
  "function quoteBuy(uint256) view returns (uint256,uint256,uint256)",
  "function quoteSell(uint256) view returns (uint256,uint256,uint256,bool)",
  "function paused() view returns (bool)",
  "function circuitBreaker() view returns (bool)"
];

// UI
const $ = id => document.getElementById(id);
const status = (t, ok=true) => {
  $("status").textContent = t;
  $("status").className = ok ? "ok" : "err";
};

// CONNECT
$("connect").onclick = async () => {
  if (!window.ethereum) return alert("MetaMask requerido");

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  user = await signer.getAddress();

  $("account").textContent = user;
  $("amount").disabled = false;
  $("buy").disabled = false;
  $("sell").disabled = false;

  await loadBalances();
};

// BALANCES
async function loadBalances() {
  const dbn = new ethers.Contract(DBN, ERC20_ABI, provider);
  const dab = new ethers.Contract(DAB, ERC20_ABI, provider);

  const [dbnD, dabD] = await Promise.all([dbn.decimals(), dab.decimals()]);
  const [dbnB, dabB] = await Promise.all([
    dbn.balanceOf(user),
    dab.balanceOf(user)
  ]);

  $("dbnBal").textContent = ethers.utils.formatUnits(dbnB, dbnD);
  $("dabBal").textContent = ethers.utils.formatUnits(dabB, dabD);
}

// BUY
$("buy").onclick = async () => {
  try {
    const amount = $("amount").value;
    if (!amount || amount <= 0) return;

    const swap = new ethers.Contract(SWAP, SWAP_ABI, signer);
    if (await swap.paused() || await swap.circuitBreaker())
      throw "Swap pausado";

    const dbn = new ethers.Contract(DBN, ERC20_ABI, signer);
    const dec = await dbn.decimals();
    const value = ethers.utils.parseUnits(amount, dec);

    const allowance = await dbn.allowance(user, SWAP);
    if (allowance.lt(value)) {
      status("Aprobando DBN...");
      await (await dbn.approve(SWAP, value)).wait();
    }

    status("Comprando DAB...");
    await (await swap.buy(value)).wait();

    status("Compra completada âœ”");
    await loadBalances();

  } catch (e) {
    status(e.reason || e.toString(), false);
  }
};

// SELL
$("sell").onclick = async () => {
  try {
    const amount = $("amount").value;
    if (!amount || amount <= 0) return;

    const swap = new ethers.Contract(SWAP, SWAP_ABI, signer);
    if (await swap.paused() || await swap.circuitBreaker())
      throw "Swap pausado";

    const dab = new ethers.Contract(DAB, ERC20_ABI, signer);
    const dec = await dab.decimals();
    const value = ethers.utils.parseUnits(amount, dec);

    const allowance = await dab.allowance(user, SWAP);
    if (allowance.lt(value)) {
      status("Aprobando DAB...");
      await (await dab.approve(SWAP, value)).wait();
    }

    status("Vendiendo DAB...");
    await (await swap.sell(value)).wait();

    status("Venta completada âœ”");
    await loadBalances();

  } catch (e) {
    status(e.reason || e.toString(), false);
  }
};

    const preview = $("preview");

$("amount").oninput = async () => {
  preview.textContent = "";
  $("status").textContent = "";

  const amount = $("amount").value;
  if (!amount || amount <= 0 || !provider) return;

  try {
    const swap = new ethers.Contract(SWAP, SWAP_ABI, provider);
    const dbn = new ethers.Contract(DBN, ERC20_ABI, provider);
    const dab = new ethers.Contract(DAB, ERC20_ABI, provider);

    const [dbnDec, dabDec] = await Promise.all([
      dbn.decimals(),
      dab.decimals()
    ]);

    if (mode === "buy") {
      const dbnIn = ethers.utils.parseUnits(amount, dbnDec);
      const [dabOut, fee] = await swap.quoteBuy(dbnIn);

      if (dabOut.gt(0)) {
        preview.textContent =
          `Comprar â†’ Recibes ${ethers.utils.formatUnits(dabOut, dabDec)} DAB | Fee: ${ethers.utils.formatUnits(fee, dbnDec)} DBN`;
      }
    }

    if (mode === "sell") {
      const dabIn = ethers.utils.parseUnits(amount, dabDec);
      const [dbnOut, fee, , allowed] = await swap.quoteSell(dabIn);

      preview.textContent = allowed
        ? `Vender â†’ Recibes ${ethers.utils.formatUnits(dbnOut, dbnDec)} DBN | Fee: ${ethers.utils.formatUnits(fee, dbnDec)} DBN`
        : "Venta no permitida (reserva / lÃ­mites)";
    }

  } catch (e) {
    preview.textContent = "";
  }
};
    </script>
</body>
</html>
