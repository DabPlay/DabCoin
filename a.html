<!DOCTYPE html>
<html>
<head>
  <title>DAB → DBN Redemption</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js"></script>
</head>
<body style="font-family: Arial; background:#111; color:white; text-align:center; padding-top:50px;">

<h2>DAB → DBN Redemption</h2>

<button onclick="connectWallet()">Connect Wallet</button>

<p id="wallet"></p>
<p id="dabBalance"></p>
<p id="dbnAvailable"></p>
<p id="priceInfo"></p>

<input type="number" id="dabAmount" placeholder="DAB to redeem" />
<br><br>

<button onclick="approveDAB()">Approve DAB</button>
<button onclick="redeemDAB()">Redeem</button>

<p id="status"></p>

<script>
let provider;
let signer;
let user;

const DAB_ADDRESS = "0x9471052e67163Ac9eD01BAAe0894ec2f59313777";
const REDEMPTION_ADDRESS = "0x379d02E48fF44cCDcb7Dea222aE823F5d0dEe18c";

const DAB_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function balanceOf(address account) external view returns (uint256)",
  "function decimals() external view returns (uint8)"
];

const REDEMPTION_ABI = [
  "function redeem(uint256 dabAmount) external",
  "function internalPrice() view returns (uint256)",
  "function redeemableDBNPerDay() view returns (uint256)"
];

async function connectWallet() {
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  user = await signer.getAddress();

  document.getElementById("wallet").innerText = "Connected: " + user;

  loadData();
}

async function loadData() {
  const dab = new ethers.Contract(DAB_ADDRESS, DAB_ABI, provider);
  const redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, provider);

  const balance = await dab.balanceOf(user);
  const decimals = await dab.decimals();
  const formatted = ethers.formatUnits(balance, decimals);

  document.getElementById("dabBalance").innerText = "DAB Balance: " + formatted;

  const price = await redemption.internalPrice();
  const readablePrice = ethers.formatUnits(price, 18);
  document.getElementById("priceInfo").innerText = "Internal Price (DBN per DAB): " + readablePrice;

  const available = await redemption.redeemableDBNPerDay();
  document.getElementById("dbnAvailable").innerText = "DBN Available Today: " + ethers.formatUnits(available, 18);
}

async function approveDAB() {
  const amount = document.getElementById("dabAmount").value;
  const dab = new ethers.Contract(DAB_ADDRESS, DAB_ABI, signer);
  const decimals = await dab.decimals();

  const parsed = ethers.parseUnits(amount, decimals);
  const tx = await dab.approve(REDEMPTION_ADDRESS, parsed);

  document.getElementById("status").innerText = "Approving...";
  await tx.wait();
  document.getElementById("status").innerText = "Approved!";
}

async function redeemDAB() {
  const amount = document.getElementById("dabAmount").value;
  const dab = new ethers.Contract(DAB_ADDRESS, DAB_ABI, provider);
  const decimals = await dab.decimals();
  const parsed = ethers.parseUnits(amount, decimals);

  const redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, signer);
  const tx = await redemption.redeem(parsed);

  document.getElementById("status").innerText = "Redeeming...";
  await tx.wait();
  document.getElementById("status").innerText = "Redeemed successfully!";

  loadData();
}
</script>

</body>
</html>
