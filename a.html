<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dabcoin Exchange</title>

<!-- Ethers v5 (compatible con MetaMask) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
    margin: 0;
    background: #0f172a;
    color: white;
    font-family: Arial, sans-serif;
}

.container {
    max-width: 500px;
    margin: 60px auto;
    background: #1e293b;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

h2 { text-align: center; }

button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}

.primary { background: #3b82f6; color: white; }
.success { background: #16a34a; color: white; }
.warning { background: #f59e0b; color: white; }

input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    margin-top: 10px;
}

.info {
    background: #0f172a;
    padding: 10px;
    margin-top: 15px;
    border-radius: 6px;
    font-size: 14px;
}

.status {
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
}
</style>
</head>
<body>

<div class="container">
<h2>Dabcoin Exchange</h2>

<button class="primary" onclick="connectWallet()">Conectar Wallet</button>

<div class="info">
<p id="wallet">Wallet: -</p>
<p id="dabBalance">DAB Balance: -</p>
<p id="dbnBalance">DBN Balance: -</p>
<p id="price">Internal Price: -</p>
<p id="daily">Daily DBN Available: -</p>
</div>

<h3>Comprar DAB</h3>
<input type="number" id="buyAmount" placeholder="Cantidad DBN">
<button class="success" onclick="approveDBN()">Approve DBN</button>
<button class="success" onclick="buyDAB()">Buy DAB</button>

<h3>Redimir DAB</h3>
<input type="number" id="redeemAmount" placeholder="Cantidad DAB">
<button class="warning" onclick="approveDAB()">Approve DAB</button>
<button class="warning" onclick="redeemDAB()">Redeem</button>
<p id="buyInfo"></p>
<p id="redeemInfo"></p>

<button onclick="buyDAB()">Comprar DAB</button>
<button onclick="redeemDAB()">Redimir DAB</button>
<p class="status" id="status"></p>
</div>

<script>

// ================= CONFIG =================
const DAB_ADDRESS = "0x9471052e67163Ac9eD01BAAe0894ec2f59313777";
const DBN_ADDRESS = "0x2fD13338f4e9485fC33Be4DE53F4f6ff536811cD";
const REDEMPTION_ADDRESS = "0x379d02E48fF44cCDcb7Dea222aE823F5d0dEe18c";
// ==========================================

const ERC20_ABI = [
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function balanceOf(address owner) view returns (uint256)",
    "function decimals() view returns (uint8)"
];

const REDEMPTION_ABI = [
    "function buyDAB(uint256 dbnAmount) external",
    "function redeem(uint256 dabAmount) external",
    "function internalPrice() view returns (uint256)",
    "function redeemableDBNPerDay() view returns (uint256)"
];

let provider, signer, user;
let dabContract, dbnContract, redemption;

// ================= CONNECT =================
async function connectWallet() {

    if (!window.ethereum) {
        alert("Instala MetaMask");
        return;
    }

    if (!confirm("¿Conectar wallet?")) return;

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);

    signer = provider.getSigner();
    user = await signer.getAddress();

    dabContract = new ethers.Contract(DAB_ADDRESS, ERC20_ABI, provider);
    dbnContract = new ethers.Contract(DBN_ADDRESS, ERC20_ABI, provider);
    redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, provider);

    document.getElementById("wallet").innerText = "Wallet: " + user;

    loadData();
}

// ================= LOAD DATA =================
async function loadData() {

    const dabBal = await dabContract.balanceOf(user);
    const dbnBal = await dbnContract.balanceOf(user);

    const dabDec = await dabContract.decimals();
    const dbnDec = await dbnContract.decimals();

    const price = await redemption.internalPrice();
    const dailyLimit = await redemption.redeemableDBNPerDay();

    const dabFormatted = parseFloat(ethers.utils.formatUnits(dabBal, dabDec));
    const dbnFormatted = parseFloat(ethers.utils.formatUnits(dbnBal, dbnDec));
    const priceFormatted = parseFloat(ethers.utils.formatUnits(price, 18));
    const dailyFormatted = parseFloat(ethers.utils.formatUnits(dailyLimit, dbnDec));

    document.getElementById("dabBalance").innerText =
        "Tienes: " + dabFormatted.toFixed(4) + " DAB";

    document.getElementById("dbnBalance").innerText =
        "Tienes: " + dbnFormatted.toFixed(4) + " DBN";

    document.getElementById("price").innerText =
        "Precio interno: 1 DAB = " + priceFormatted.toFixed(4) + " DBN";

    // CALCULAR COMPRA POSIBLE
    const maxDabBuy = dbnFormatted / priceFormatted;

    document.getElementById("buyInfo").innerText =
        "Puedes comprar hasta: " + maxDabBuy.toFixed(4) + " DAB";

    // CALCULAR REDEEM POSIBLE
    const maxDbnFromDab = dabFormatted * priceFormatted;
    const redeemableToday = Math.min(maxDbnFromDab, dailyFormatted);

    document.getElementById("redeemInfo").innerText =
        "Puedes retirar máximo: " + redeemableToday.toFixed(4) + " DBN hoy";

    if (dailyFormatted === 0) {
        document.getElementById("status").innerText =
            "⚠ Límite diario alcanzado";
    }
}

// ================= BUY (AUTO APPROVE) =================
async function buyDAB() {

    document.getElementById("status").innerText =
        "Esperando confirmación...";

    const dbnWithSigner = dbnContract.connect(signer);
    const redemptionWithSigner = redemption.connect(signer);

    const dbnBal = await dbnContract.balanceOf(user);
    const decimals = await dbnContract.decimals();

    const tx1 = await dbnWithSigner.approve(REDEMPTION_ADDRESS, dbnBal);
    await tx1.wait();

    const tx2 = await redemptionWithSigner.buyDAB(dbnBal);
    await tx2.wait();

    document.getElementById("status").innerText =
        "Compra completada";

    loadData();
}

// ================= REDEEM (AUTO APPROVE) =================
async function redeemDAB() {

    const dabBal = await dabContract.balanceOf(user);
    const decimals = await dabContract.decimals();

    if (dabBal == 0) {
        document.getElementById("status").innerText =
            "No tienes DAB suficiente";
        return;
    }

    document.getElementById("status").innerText =
        "Esperando confirmación...";

    const dabWithSigner = dabContract.connect(signer);
    const redemptionWithSigner = redemption.connect(signer);

    const tx1 = await dabWithSigner.approve(REDEMPTION_ADDRESS, dabBal);
    await tx1.wait();

    const tx2 = await redemptionWithSigner.redeem(dabBal);
    await tx2.wait();

    document.getElementById("status").innerText =
        "Redimido correctamente";

    loadData();
}

</script>
</body>
</html>
