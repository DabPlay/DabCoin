<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dabcoin Exchange</title>

<!-- Ethers v5 (compatible con MetaMask) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
    margin: 0;
    background: #0f172a;
    color: white;
    font-family: Arial, sans-serif;
}

.container {
    max-width: 500px;
    margin: 60px auto;
    background: #1e293b;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

h2 { text-align: center; }

button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}

.primary { background: #3b82f6; color: white; }
.success { background: #16a34a; color: white; }
.warning { background: #f59e0b; color: white; }

input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    margin-top: 10px;
}

.info {
    background: #0f172a;
    padding: 10px;
    margin-top: 15px;
    border-radius: 6px;
    font-size: 14px;
}

.status {
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
}
</style>
</head>
<body>

<div class="container">
<h2>Dabcoin Exchange</h2>

<button class="primary" onclick="connectWallet()">Conectar Wallet</button>

<div class="info">
<p id="wallet">Wallet: -</p>
<p id="dabBalance">DAB Balance: -</p>
<p id="dbnBalance">DBN Balance: -</p>
<p id="price">Internal Price: -</p>
<p id="daily">Daily DBN Available: -</p>
</div>

<h3>Comprar DAB</h3>
<input type="number" id="buyAmount" placeholder="Cantidad DBN">
<button class="success" onclick="approveDBN()">Approve DBN</button>
<button class="success" onclick="buyDAB()">Buy DAB</button>

<h3>Redimir DAB</h3>
<input type="number" id="redeemAmount" placeholder="Cantidad DAB">
<button class="warning" onclick="approveDAB()">Approve DAB</button>
<button class="warning" onclick="redeemDAB()">Redeem</button>

<p class="status" id="status"></p>
</div>

<script>

// ================= CONFIG =================
const DAB_ADDRESS = "0x9471052e67163Ac9eD01BAAe0894ec2f59313777";
const DBN_ADDRESS = "0x2fD13338f4e9485fC33Be4DE53F4f6ff536811cD";
const REDEMPTION_ADDRESS = "0x379d02E48fF44cCDcb7Dea222aE823F5d0dEe18c";
// ==========================================

const ERC20_ABI = [
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function balanceOf(address owner) view returns (uint256)",
    "function decimals() view returns (uint8)"
];

const REDEMPTION_ABI = [
    "function buyDAB(uint256 dbnAmount) external",
    "function redeem(uint256 dabAmount) external",
    "function internalPrice() view returns (uint256)",
    "function redeemableDBNPerDay() view returns (uint256)"
];

let provider, signer, user;

// ================= CONNECT =================
async function connectWallet() {

    if (typeof window.ethereum === "undefined") {
        alert("Instala MetaMask");
        return;
    }

    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);

        signer = provider.getSigner();
        user = await signer.getAddress();

        document.getElementById("wallet").innerText = "Wallet: " + user;
        document.getElementById("status").innerText = "Wallet conectada";

        loadData();

    } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Error conectando wallet";
    }
}

// ================= LOAD DATA =================
async function loadData() {

    const dab = new ethers.Contract(DAB_ADDRESS, ERC20_ABI, provider);
    const dbn = new ethers.Contract(DBN_ADDRESS, ERC20_ABI, provider);
    const redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, provider);

    const dabBal = await dab.balanceOf(user);
    const dbnBal = await dbn.balanceOf(user);

    const dabDec = await dab.decimals();
    const dbnDec = await dbn.decimals();

    document.getElementById("dabBalance").innerText =
        "DAB Balance: " + ethers.utils.formatUnits(dabBal, dabDec);

    document.getElementById("dbnBalance").innerText =
        "DBN Balance: " + ethers.utils.formatUnits(dbnBal, dbnDec);

    const price = await redemption.internalPrice();
    document.getElementById("price").innerText =
        "Internal Price (DBN per DAB): " + ethers.utils.formatUnits(price, 18);

    const daily = await redemption.redeemableDBNPerDay();
    document.getElementById("daily").innerText =
        "Daily DBN Available: " + ethers.utils.formatUnits(daily, dbnDec);
}

// ================= APPROVE DBN =================
async function approveDBN() {
    const amount = document.getElementById("buyAmount").value;
    const dbn = new ethers.Contract(DBN_ADDRESS, ERC20_ABI, signer);
    const decimals = await dbn.decimals();

    const parsed = ethers.utils.parseUnits(amount, decimals);
    const tx = await dbn.approve(REDEMPTION_ADDRESS, parsed);

    document.getElementById("status").innerText = "Aprobando DBN...";
    await tx.wait();
    document.getElementById("status").innerText = "DBN Aprobado";
}

// ================= BUY =================
async function buyDAB() {
    const amount = document.getElementById("buyAmount").value;
    const dbn = new ethers.Contract(DBN_ADDRESS, ERC20_ABI, provider);
    const decimals = await dbn.decimals();

    const parsed = ethers.utils.parseUnits(amount, decimals);

    const redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, signer);
    const tx = await redemption.buyDAB(parsed);

    document.getElementById("status").innerText = "Comprando DAB...";
    await tx.wait();
    document.getElementById("status").innerText = "DAB Comprado";
    loadData();
}

// ================= APPROVE DAB =================
async function approveDAB() {
    const amount = document.getElementById("redeemAmount").value;
    const dab = new ethers.Contract(DAB_ADDRESS, ERC20_ABI, signer);
    const decimals = await dab.decimals();

    const parsed = ethers.utils.parseUnits(amount, decimals);
    const tx = await dab.approve(REDEMPTION_ADDRESS, parsed);

    document.getElementById("status").innerText = "Aprobando DAB...";
    await tx.wait();
    document.getElementById("status").innerText = "DAB Aprobado";
}

// ================= REDEEM =================
async function redeemDAB() {
    const amount = document.getElementById("redeemAmount").value;
    const dab = new ethers.Contract(DAB_ADDRESS, ERC20_ABI, provider);
    const decimals = await dab.decimals();

    const parsed = ethers.utils.parseUnits(amount, decimals);

    const redemption = new ethers.Contract(REDEMPTION_ADDRESS, REDEMPTION_ABI, signer);
    const tx = await redemption.redeem(parsed);

    document.getElementById("status").innerText = "Redimiendo...";
    await tx.wait();
    document.getElementById("status").innerText = "Redimido correctamente";
    loadData();
}

</script>
</body>
</html>
